package com.wanniu.game;

import java.io.File;
import java.io.FileFilter;
import java.io.IOException;

import com.wanniu.core.GConfig;
import com.wanniu.core.GSystem;
import com.wanniu.core.game.GServerBootstrap;
import com.wanniu.core.game.LangService;
import com.wanniu.core.logfs.Out;
import com.wanniu.core.util.DataUtil;
import com.wanniu.game.achievement.AchievementServiceNew;
import com.wanniu.game.activity.DemonTowerService;
import com.wanniu.game.arena.ArenaService;
import com.wanniu.game.auction.AuctionDataManager;
import com.wanniu.game.chat.GmCommandManager;
import com.wanniu.game.common.ScheduleManager;
import com.wanniu.game.consignmentShop.ConsignmentLineService;
import com.wanniu.game.daoyou.DaoYouCenter;
import com.wanniu.game.daoyou.DaoYouService;
import com.wanniu.game.data.GameData;
import com.wanniu.game.data.ServerConfigCO;
import com.wanniu.game.fightLevel.DungeonService;
import com.wanniu.game.five2Five.Five2FiveService;
import com.wanniu.game.flee.FleeService;
import com.wanniu.game.friend.FriendsCenter;
import com.wanniu.game.guild.GuildServiceCenter;
import com.wanniu.game.guild.guidDepot.GuildDepotCenter;
import com.wanniu.game.guild.guildBless.GuildBlessCenter;
import com.wanniu.game.guild.guildBoss.GuildBossService;
import com.wanniu.game.guild.guildFort.GuildFortCenter;
import com.wanniu.game.guild.guildFort.GuildFortService;
import com.wanniu.game.guild.guildImpeach.GuildImpeachCenter;
import com.wanniu.game.mail.MailCenter;
import com.wanniu.game.player.GlobalConfig;
import com.wanniu.game.player.PathService;
import com.wanniu.game.rank.RankCenter;
import com.wanniu.game.recent.RecentChatCenter;
import com.wanniu.game.redpacket.RedPacketService;
import com.wanniu.game.rich.RichManager;
import com.wanniu.game.shopMall.ShopMallService;
import com.wanniu.game.solo.SoloService;

/**
 * 游戏服启动入口类.
 *
 * @author 周明凯(zhoumingkai@qeng.cn)
 */
public class GMain {

	private static int TableCount = 0;

	// --------------------美女保佑，永无Bug，不改需求，早点下班--------------------------------

	// ...............8888:::8888888888888888888888888
	// .............8888::::::8888888888888888888888888888
	// ............88::::::::888:::8888888888888888888888888
	// ..........88888888::::8:::::::::::88888888888888888888
	// ........888.8::888888::::::::::::::::::88888888888...888
	// ...........88::::88888888::::8::::::::::88888888888....8
	// .........888888888888888888:8:::::::::::8888888888888
	// ........88888888888888888888::::::::::::888888888888888
	// ........8888888888888888888888:::::::::88888888888888888
	// .........8888888888888888888888:::::::8888888888888888888
	// ........8888888888888888::88888::::::888888888888888888888
	// ......88888888888888888:::88888:::::8888888888888888...8888
	// .....88888888888888888:::88888::::8::;o*8*o;888888888....88
	// ....88888888888888888:::8888:::::8:::::::::::88888888....8
	// ...88888888888888888::::88::::::8:;:::::::::::888888888
	// ..8888888888888888888:::8::::::8::aAa::::::::88888888888.......8
	// ..88...8888888888::88::::8::::8:::::::::::::888888888888888.8888
	// .88..88888888888:::8:::::::::8::::::::::;::88:88888888888888888
	// .8..8888888888888:::::::::::8::'@@@@@@@'::::8w8888888888888888
	// ..88888888888:888::::::::::8:::::'@a@':::::88i888888888888888
	// .8888888888::::88:::::::::888:::::::::::::888z88888888888888888
	// 8888888888:::::8:::::::::888888:::::::::88888!888888888888888888
	// 888888888:::::8:::::::::888888888A888A8V88888*88888888...88888888
	// 888888.8:::::::::::::::8888888888:::::::8888888888888888...8888888
	// 8888...8::::::::::::::888888888888::::::88888888888888888....88888
	// .888...8:::::::::::::888888888888888:::::88888888888888888....8888
	// ..888..8::::::::::::88888:888888888888::::8::8888888.888888...8888
	// ...88..8::::::::::::8888:88888888888888888::::::888...88888...888
	// ...88..8::::::::::88888::88888::888888888888:::::::8888888....88
	// ...8...88::::::::88888:::8888:::::888888888888::::::::888.....4
	// .......88:::::::88888:::::888:::::::88:::8888888::::::::88....2
	// ......8888:::::88888:::::::88::::::::8:::::888888:::8:::::8
	// .....88888:::::88888::::::::8:::::::::::8::::8888::::8::::8
	// ....888888:::::88:8::::::::::8:::::::::::8:::8888::::::8::8
	// ...88.88888:::888:8:::::::::::::::::::::::8:8888:::::::::8:
	// ...8.888888:::88::8:::::::::::::::::::::::88:88::::::::::::8
	// .....888888:::88::8::::::::::*88*::::::::::8:88::::::::::::::8
	// ....8888888:::88::8:::::::::88@@88:::::::::8::88::::::::::::::8
	// ....88888888::88::88::::::::88@@88:::::::::8:::8::::::::::::::*8
	// ....88888..8:::8::88:::::::::*88*::::::::::8:::::::::::::::::88@@
	// ....8888...88::::::88:::::::::::::::::::::88:::::::::::::::::88@@
	// .....888....8:::::::88:::::::::::::::::::88::8::::::::::::::::*8
	// .....888....88:::::::888::::::::::::::::88:::88:::::::::::::::8
	// ......88.....8::::::::8888:::::::::::8888:::::88::::::::::::88
	// .......88....88:::::::::888888888888888::::::::88:::::::::88
	// ........88....88::::::::::::8888888::::::::::::::888888888
	// .........88...888::::::::::::::::::::::::::::::::::888888
	// ..........8...8888::::::::::::::::::::::8:::8::::::::88
	// ..............88888::::::::::::::::::88::::::88::::::88
	// .............8888888:::::::::::::::888:::::::88:::::88
	// .............88888888:::::::::::::888:::::::::888:::8
	// ............8888888888:::::::::::888:::::::::::88:::8
	// ...........88.88888888:::::::::888::::::::::::::8:::8
	// ...........8..888888.8:::::::88:::::::::::::::::8:::8:
	// ..............888888.8::::::8:::::::::::::::::::8:::88
	// .............888888..8:::::8::::::::::::::::::::::::8:8
	// .............888888..8:::::8:::::::::@::::::::::::::8::8
	// .............88888...8::::::::::::::@@:::::::::::::::8::8
	// ............88888...8::::::::::::::@@@::::::::::::::::8::8
	// ...........88888...8:::::::::::::::@@::::::::::::::::::8::8
	// ..........88888...8:::::8::::::::::@::::::::::88:::::::8:::8
	// ..........8888...8:::::8:::::::::::::::::::::::88:::::::8:::8
	// .........8888...8:::::8:::::::::::::::::::::::888::::::::8:::8
	// ........888....8:::::88::::::::::::::::::::::888:::::::::8::::8
	// ......8888....88::::88:::::::::::::::::::::8888:::::::::8::8:::8
	// .....888......8:::::8::::::::::::::::::::888::::::::::::8::88:::8
	// ..8888.......88:::::::::::::::::::::::::88:::::::::::::88::88:::8:
	// .............8:::::::::::::::::::::::::8:::::::::::::::88::88:::88
	// ............88::::::8:::::::::::::::::::::::::::::::::::8::88:::88
	// ............8::::::::8:::::::::::::::::::::::::::::::::::8::8:::88
	// ...........88:::::::::8:::::::::::::8:::::::::::::::::::::8:8:::88
	// ...........8:::::::::::888:::::::::8:::::::::::::::::::::::88::888
	// ...........8::::::::::::88888888888::::::::::::::::::::::::88::88
	// ...........8:::::::::::::888888888:::::::::::::::::::::::::8::88
	// ...........8::::::::::::::8888888:::::::::::::::::::::::::8::88
	// ...........8:::::::::::::::888888:::::::::::::::::::::::::8:88
	// ...........8:::::::::::::::::888::::::::::::::::::::::::::888
	// ...........8:::::::::::::::::::8::::::::::::::::::::::::::888
	// ...........88:::::::::::::::::8::::::::::::::::::::::::::888
	// ............8:::::::::::::::::8::::::::::::::::::::::::::888
	// ............88:::::::::::::::8::::::::::::::::::::::::::888
	// .............8:::::::::::::::8:::::::::::::::::::::::::888
	// .............88:::::::::::::8:::::::::::::::::::::::::888
	// ..............8:::::::::::::8::::::::::::::::::::::::888
	// ..............88:::::::::::8::::::::::::::::::::::::888
	// ...............8:::::::::::8:::::::::::::::::::::::888
	// ...............88:::::::::8:::::::::::::::::::::::888
	// ................8:::::::::8::::::::::::::::::::::888
	// ................88:::::::8::::::::::::::::::::::888
	// .................88::::::8:::::::::::::::::::::888
	// .................88:::::8:::::::::::::::::::::888
	// ..................88::::8::::::::::::::::::::888
	// ..................88:::8::::::::::::::::::::888
	// ...................88::8:::::::::::::::::::888
	// ...................88:8:::::::::::::::::::888
	// ....................888::::::::::::::::::888
	// ....................88::::::::::::::::::888
	// .....................8:::::::::::::::::888
	// ....................88::::::::::::::::888
	// ....................88:::::::::::::::888
	// ....................88::::8:::::::::888:
	// ....................888::::88:::::::8888
	// .....................888:::::::::::888:8
	// .....................888:::8:::::::8:8:8
	// ......................88::8888:::::::8:8
	// ......................88::888::::::::8:8
	// ......................888::88::::::::8:8
	// .......................88::88:::::::::8:8
	// .......................88::88::::::::::8:8
	// .......................88:::8:::::::::::88
	// .......................888:::::::::::::::8:
	// .......................888:::::::::::::::8:
	// .......................888::::::::::::::::8
	// .......................888::::::::::::::::8
	// .......................888::::::::::::::::88
	// ........................88::::::::::::::::88
	// ........................888:::::::::::::::88
	// ........................888:::::::::::::::88
	// ........................888:::::::::::::::88
	// ........................888:::::::::::::::88
	// .........................88::::::::::::::888
	// .........................888:::::::::::::88
	// .........................888:::::::::::::88
	// .........................888::::::::::::88
	// ..........................88::::::::::::88
	// ..........................88::::::::::::88
	// ..........................88:::::::::::88
	// ..........................888::::::::::88
	// ..........................888::::::::::88
	// ...........................88:::::::::88
	// ...........................888::::::::88
	// ...........................888::::::::88
	// ............................88::::::::88
	// ............................888::::::88
	// ............................888::::::88
	// ..............................88:::::88:
	// ..............................88:::::8:8
	// ..............................88:::::8:8
	// ..............................:8::::::8:
	// .............................8:8:::::::8
	// ............................8:::8::::::8
	// ...........................8::::8::::::8
	// ..........................8:::::8:::::::8
	// .........................8::::::88:::::::8
	// .........................8:::::::8::::::::8
	// .........................8;:;::::8:::::::::8
	// .........................8:8:;:::8::::::::::8
	// .........................88:8:8::8::8::8::8:88

	// --------------------美女保佑，永无Bug，不改需求，早点下班---------------------------------

	public static void main(String[] args) {
		GConfig.getInstance().init(false);
		if (args.length > 0) {
			String ip = args[0].trim();
			GConfig.getInstance().put("game.pubhost", ip);
			if (!GConfig.getInstance().exists("game.id")) {
				String gameId = ip.substring(ip.lastIndexOf(".") + 1);
				GConfig.getInstance().put("game.id", gameId);
			}
			GWorld.__SERVER_ID = GConfig.getInstance().getGameID();
			Out.info(ip, " game id : ", GWorld.__SERVER_ID);
		}

		// 安全关服
		if (GWorld.DEBUG && GSystem.OS_NAME.startsWith("WINDOWS")) {
			new Thread(() -> {
				try {
					System.in.read();
				} catch (IOException e) {
					Out.error(e);
				}
				System.exit(0);
			}, "安全停服：测试启用").start();
		}

		initData();

		GWorld.getInstance().start();

		// 初始化计划任务
		ScheduleManager.getInstance();

		/** 加载寻路配置 */
		PathService.getInstance();
		/** 副本初始化，开始种怪 */
		DungeonService.getInstance();
		/** 加载拍卖行数据 */
		ConsignmentLineService.getInstance();
		// 竟拍数据
		AuctionDataManager.getInstance();
		// 加载全服邮件
		MailCenter.getInstance().loadServerMails();
		// 好友管理中心
		FriendsCenter.getInstance();
		// 最近联系人管理
		RecentChatCenter.getInstance();
		// 仙盟管理中心
		GuildServiceCenter.getInstance().init();
		GuildImpeachCenter.getInstance();
		GuildDepotCenter.getInstance();
		GuildBlessCenter.getInstance();
		// 道友
		DaoYouService.getInstance();
		DaoYouCenter.getInstance();
		// 竞技场大乱斗(五岳一战)
		ArenaService.getInstance();
		// 单挑问道大会
		SoloService.getInstance();
		// 5v5
		Five2FiveService.getInstance();
		FleeService.getInstance();
		// 成就初始化分类
		AchievementServiceNew.getInstance();
		// 商城(每周限购)服务
		ShopMallService.getInstance();
		// 排行榜（新）
		RankCenter.getInstance().init();
		// 仙盟BOSS
		GuildBossService.getInstance().init();
		GmCommandManager.init();
		//仙盟据点战
		GuildFortService.getInstance();
		GuildFortCenter.getInstance();
		//红包
		RedPacketService.getInstance().init();
		//镇妖塔
		DemonTowerService.getInstance().init();

		// 所有功能都准备OK后，再对外开放端口.
		GServerBootstrap.getInstance().start();
		GSystem.free();
		Out.info("SID-> ", GWorld.__SERVER_ID, "    ENV -> ", GWorld.__SERVER_LANG, "    DEBUG -> ", GWorld.DEBUG, "    MONITOR -> ", GWorld.MONITOR);
		Out.info("游戏已成功启动运行喽，O(∩_∩)O~");
		System.out.println("游戏已成功启动运行喽，O(∩_∩)O~");
	}

	private static void loadData(File parent) {
		File[] tables = parent.listFiles(new FileFilter() {
			@Override
			public boolean accept(File file) {
				if (file.isDirectory()) {
					loadData(file);
				}
				if (file.getName().endsWith(".json")) {
					DataUtil.loadData(file);
					return true;
				}
				return false;
			}
		});
		TableCount += tables.length;
	}

	public static void initData() {
		// DataUtil.setDir("src/data/com/wanniu/game/data");
		DataUtil.addExtClass("com.wanniu.game.data");
		File dataDir = new File(GConfig.getInstance().get("dir.game.data"));
		loadData(dataDir);
		Out.info("Load table count:", TableCount);

		// 语言包位置，需要在此时初始化
		for (ServerConfigCO t : GameData.ServerConfigs.values()) {
			LangService.put(t.paramNameS, t.showTxt);
		}

		DataUtil.initProperty();

		GlobalConfig.init();
	}
}